<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script src="http://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
		<link rel="stylesheet" type="text/css" href="../../static/css/header/header.css"/>
		<link rel="stylesheet" type="text/css" href="../../static/css/public/index.css"/>
		<script src="https://cdn.bootcss.com/vue/2.4.2/vue.min.js"></script>
		<link rel="stylesheet" href="../../static/css/base.css" />
		<title></title>
		<style>
			.cq-content{
				float: left;
				width:180px;
				margin: 0 5px 0 0;
			}
			.cp-content{
				float: left;
				width:760px;
			}
			
			.classInfo{
				text-align: center;

			}
			.classInfo .img	img{
				width: 88px;
				height: 88px;
				border-radius: 88px;
				
			}
			.column2{
				width:200px
			}
			.menu ul{
				padding:  0 0 0 0;
				margin:  0 0 0 0;
				
			}
			.menu ul li{
				padding: 5px;
			}
			.menu ul li a img{
				width: 16px;
				height: 16px;
				
			}
			
			.files{
				
				
			}
			.file{
				float:left;
				text-align: center;
				margin: 10px;
				cursor: pointer;
				
			}
			.file .file-img{
				
			}
			.file .file-font{
				
				
			}
			.footer{
				position: absolute;
				bottom:20px;
				right:20px
			}
	
		</style>
		
	</head>
	<body >
		<div class="header" id="header">
			<div class="icon">
				<img src="../../static/img/icon.png" class="img" />
			</div>
			
			<ul>
				<li>
					<a href="index2teacher.html" style="color: white;">课堂管理</a>
					
					
				</li>
				
				
				
			</ul>
			<div class="right">
				<a href="" >
					购物车
				</a>
				<a href="">
					登录
				</a>
				<a href="">
					注册
				</a>
					
			</div>
			<div style="clear: both;"></div>
		</div>
		<div class="bodyer">
			
			<div class="bodyCenter">
				<div class="cq-content">
					<div class="module-box">
						<div class="classInfo"> 
							<div class="img">
								<img src="http://localhost:8080/resource/seofhsohflkzshbfclzjk.jpg" alt="" />
							</div>
							<div class="className">
								javaEE企业级开发
							</div>
							<div class="classDesc">
								周三1-2节课
							</div>
						</div>
						<div class="clear"></div>
					</div>
					<div class="module-box">
						<div class="menu">
						<ul>
							<li>	
								<a onclick="go('enterOneClass.html')">
									<img src="../../static/img/teacher/列表.png" alt="" />
									<span>班级列表</span>
								</a>
							</li>
							<li>	
								<a onclick="go('enterOneClassTest.html')">
									<img src="../../static/img/teacher/考试.png" alt="" />
									<span>考试信息</span>
								</a>
							</li>
							<li>	
								<a onclick="go('enterOneClassSign.html')">
									<img src="../../static/img/teacher/签到.png" alt="" />
									<span>班级签到</span>
								</a>
							</li>
							<li>	
								<a onclick="go('enterOneClassNotice.html')">
									<img src="../../static/img/teacher/公告发布.png" alt="" />
									<span>发布公告</span>
								</a>
							</li>
							<li>	
								<a onclick="go('enterOneClassResource.html')">
									<img src="../../static/img/teacher/上传.png" alt="" />
									<span>资源管理</span>
								</a>
							</li>
							<li>	
								<a onclick="go('enterOneClassHomework.html')">
									<img src="../../static/img/teacher/作业.png" alt="" />
									<span>作业信息</span>
								</a>
							</li>
							
						</ul>
						</div>
					</div>
				
					
					
				</div>
				<div class="cp-content">
					<div class="module-box">
						<h1 class="h1">
							资源管理
							<div style="text-align: right;float: right;">
								<button class="btn" onclick="chooseFile()">资源上传</button>
							</div>
							
							<div class="clear"></div>
						</h1>
						
						<div class="files" id="files" v-on:change="change">
							<div class="file">
								<div class="file-img">
									<a onclick="back()" id="fatherDir">
										<img src="../../static/img/studentClass/dir.png" alt="" />	
									</a>
									<div class="file-font">
										<font>返回上一层目录</font>
									</div>
									
								</div>
								
							</div>
							
							<div class="file" v-for="file in files" v-bind:data-id = "file.id" >
								
								<div class="file-img" v-if="file.types=='dir'" >
									<div>
										<img src="../../static/img/studentClass/dir.png" alt="" v-bind:onclick="['openDir('+file.id+')']" v-bind:data-id="file.fatherId" />
									</div>
									
								</div>
								
								<div class="file-img" v-else-if="file.types=='txt'" >
									<a v-bind:href="['http://127.0.0.1:8080/class_resource/download?url='+file.url]">
									<img src="../../static/img/studentClass/txt.png" alt="" v-bind:data-id="file.fatherId" />
									</a>
								</div>
								<div class="file-img" v-else-if="file.types=='zip'" >
									<a v-bind:href="['http://127.0.0.1:8080/class_resource/download?url='+file.url]">
									<img src="../../static/img/studentClass/zip.png" alt="" v-bind:data-id="file.fatherId" />
									</a>
								</div>
								<div class="file-img" v-else-if="file.types=='png'" >
									<a v-bind:href="['http://127.0.0.1:8080/class_resource/download?url='+file.url]">
										<img src="../../static/img/studentClass/png.png" alt="" v-bind:data-id="file.fatherId" />
										
									</a>
									
								</div>
								<div class="file-img" v-else >
									<a v-bind:href="['http://127.0.0.1:8080/class_resource/download?url='+file.url]">
										<img src="../../static/img/studentClass/other.png" alt="" v-bind:data-id="file.fatherId" />
										
									</a>
									
								</div>
								
								<div class="file-font">
									<font>{{file.shortName}}</font>
								</div>
								
								
							</div>
							<div class="clear"></div>
						</div>
						<div class="page-util">
							<ul>
								<li>首页</li>
								<li>上一页</li>
								<li class="page-util-active" style="color: #FFF;">1</li>
								<li>2</li>
								<li>3</li>
								<li>4</li>
								<li>5</li>
								<li>6</li>
								<li>7</li>									
								<li>8</li>
								<li>下一页</li>
								<li>末页</li>
							</ul>
						</div>
						<div class="clear"></div>
						
					</div>
					
				</div>	
				
			</div>
			
			
			
		</div>
		
		
		<div class="footer">
			
		</div>
		
		
	</body>
	 <form id="form-add" style="display: none;">
		<input type="file" name="file" id="file"><br>
	</form>
	
	
	<div id="dialog" class="dialog">
		
		<div class="content">
			文件名:<input type="text" id="fileNameInput" class="input" />
			
		</div>
		<div class="footer">
			<button class="btn" onclick="sureToChange()">确认</button>	
			<button class="btn" onclick="hideDialog()">取消</button>	
		</div>
		
	</div>
	<div id="mask" class="mask"></div>
	
	
</html>
<script>

	
</script>
<div id="hideMenu" class="hideMenu">
	<div class="hideMenuOption">创建文件夹</div>
	<div class="hideMenuOption">上传文件</div>
</div>
<div id="hideMenu2" class="hideMenu">
	<div class="hideMenuOption">删除文件</div>
	<div class="hideMenuOption">重命名</div>
	
</div>

<style>
.hideMenu{
width: 120px; /*设置为0 隐藏自定义菜单*/
height: 125px;
overflow: hidden; /*隐藏溢出的元素*/
box-shadow: 0 1px 1px #888,1px 0 1px #ccc;
display: none;
background: #f0f0f0;
position: absolute; /*自定义菜单相对与body元素进行定位*/
}
.hideMenuOption{
	cursor: pointer;
	width: 130px;
	height: 25px;
	line-height: 25px;
	padding: 0 10px;
}
.hideMenuOption:hover{
	background: #00BC9B;
	color: #FFF;
}
</style>

<script type="text/javascript" src="../../static/js/font.js"></script>
<script type="text/javascript" src="../../static/js/base.js" ></script>
<script type="text/javascript" src="../../static/js/teacher.js" ></script>

<script>
//	var files = document.getElementById("#files");

 
//取消默认的浏览器自带右键 很重要！！
window.oncontextmenu=function(e){
	e.preventDefault();
}
function sureToChange(){
	
	updateFileName(fileNameInput.value );
	hideDialog();
}

var ok = 0;
var chooseFileId = -1;
function bindRightClick(){
	$(".file-img").bind("contextmenu", function(){
        return false;
    })


		$("#files").mousedown(function(e){
			if(event.button==2){
				$("#hideMenu2").hide();
				showMenu(e)
			}
		})
	
	$(".file").on("mousedown",function (e){
		if(e.button==2){
			$("#hideMenu").hide();
			showMenuForOneFile(e);
			
			chooseFileId = $(this).attr("data-id")
			
			return false;
		}
	})
}



function showMenuForOneFile(e){
	e.preventDefault();
	var menu=document.querySelector("#hideMenu2");
	menu.style.left=e.clientX+'px';
	menu.style.top=e.clientY+'px';
	$("#hideMenu2").show();
}

function showMenu(e){
	e.preventDefault();
	var menu=document.querySelector("#hideMenu");
	menu.style.left=e.clientX+'px';
	menu.style.top=e.clientY+'px';
	$("#hideMenu").show();
	
}

//关闭右键菜单，很简单
$("#hideMenu2 .hideMenuOption").on("click",function(){
	
	$("#hideMenu").hide();
	$("#hideMenu2").hide();
	if($(this).html()=="删除文件"){
		deleteFile();
	}else if($(this).html()=="重命名"){
		showDialog({
			id:"dialog",
			width:450,
			height:120
			
		})
	}
})

$("#hideMenu .hideMenuOption").on("click",function(){
	$("#hideMenu").hide();
	$("#hideMenu2").hide();
	if($(this).html()=="创建文件夹"){
		mkdir();
	}else if($(this).html()=="上传文件"){
		$("#file").click();
	}
})

window.onclick=function(e){
	$("#hideMenu").hide();
	$("#hideMenu2").hide();
}
var fatherDir = -2;
var nowId = -1;


$('#file').bind('change', function() {  
    var formData = new FormData($("#form-add")[0]);
    $.ajax({
        //接口地址
        url: controllerUrl+'/upload' ,
        type: 'POST',
        data: formData,
        async: false,
        cache: false,
        contentType: false,
        processData: false,
        dataType:"json",
        success: function (data) {
       
           save(nowId,data.info);
         
           
           
			console.log(data);
        },
        error: function (returndata) {
        	show("文件过大，无法上传");
           
        }
    });
    
    
});
var v=null;

showResource(1);
function deleteFile(){
	$.ajax({
		type:"get",
		url:controllerUrl+"class_resource/deleteFileByFileId",
		async:true,
		dataType:"json",
		data:{
			fileId:chooseFileId,
			token:localStorage["token"],
			
		},success:function(data){
			if(data.info=="success"){
				show("删除成功");
				showResource(1);
				
			}else if(data.info=="no_permission"){
				show("权限不足");
			}
			
			
		},error:function(data){
			
		}
	});
	
	
}


function showResource(first){
	$.ajax({
		type:"get",
		url:controllerUrl+"class_resource/show_resource_for_student_by_fatherId",
		async:true,
		dataType:"json",
		data:{
			classNumber:url("classNumber"),
			fatherId:nowId,
			first:first,
			each:7,
		},success:function(data){
			console.log(data);
			if(v==null||v=="null"){
				v = new Vue({
					el:"#files",
					data:{
						files:data.data
					},methods:{
						change:function(e){
					        alert(1);
					    }
					}
					
				});
				
				bindRightClick();
			}else{
				
				v._data.files = data.data;
				
				bindRightClick();
				//vue._data.datas
			}
			
			
			
		},error:function(datra){
			
		}
	});
	
}
function mkdir(){
	
	$.ajax({
		type:"get",
		url:controllerUrl+"class_resource/makeDir",
		async:true,
		dataType:"json",
		data:{
			token:localStorage["token"],
			classNumber:url("classNumber"),
			fatherId:nowId,			
		},success:function(data){
			
			if(data.info=="success"){
		
				showResource(1);
				
			}else if(data.info=="no_permission"){
				show("权限不足");
			}else if(data.info==""){
				
			}
			
		},error:function(data){
			
		}
		
	});
	
	
}

function save(nowId,fileUrl){
	$.ajax({
		type:"get",
		url:controllerUrl+"class_resource/uploadClassResource",
		async:true,
		dataType:"json",
		data:{
			token:localStorage["token"],
			classNumber:url("classNumber"),
			fatherId:nowId,
			fileUrl:fileUrl
			
		},success:function(data){
			if(data.info=="success"){
				show("上传成功");
				showResource(1);
			}else if(data.info=="no_permission"){
				show("权限不足");
			}else if(data.info==""){
				
			}
			
		},error:function(data){
			
		}
		
	});
}
function openDir(id){
		nowId = id;
		
		getFatherIdByResourceId(id);
		$.ajax({
			type:"get",
			url:controllerUrl+"class_resource/show_resource_for_student_by_fatherId",
			async:true,
			dataType:"json",
			data:{
				classNumber:url("classNumber"),
				fatherId:nowId,
				first:1,
				each:7,
			},success:function(data){
				console.log(data);
				v._data.files = data.data;
				bindRightClick();
			}
		});
		
	}
function getFatherIdByResourceId(resourceId){
		$.ajax({
			type:"get",
			url:controllerUrl+"class_resource/getFatherIdByResourceId",
			async:true,
			dataType:"json",
			data:{
				resourceId:resourceId,
				classNumber:url("classNumber"),
				
			},success:function(data){
				if(data.data.length==0){
						fatherDir = -2;
					//$("#fatherDir").attr("onclick","back("+data.data[0].fatherId+")");
					return;
				}
				console.log(data);
				fatherDir = data.data[0].fatherId-0;
				$("#fatherDir").attr("onclick","back("+data.data[0].fatherId+")");
			},error:function(data){
				
			}
		});		
	}

function back(){
	if(fatherDir==-2){
		alert("已经是最上层目录");
		return;
	}
	
	openDir(fatherDir);
	bindRightClick();

}

function chooseFile(){
	$("#file").click();
}
function getFatherIdByResourceId(resourceId){
	$.ajax({
		type:"get",
		url:controllerUrl+"class_resource/getFatherIdByResourceId",
		async:true,
		dataType:"json",
		data:{
			resourceId:resourceId,
			classNumber:url("classNumber"),
			
		},success:function(data){
			if(data.data.length==0){
					fatherDir = -2;
				//$("#fatherDir").attr("onclick","back("+data.data[0].fatherId+")");
				return;
			}
			console.log(data);
			fatherDir = data.data[0].fatherId-0;
		//	$("#fatherDir").attr("onclick","back("+data.data[0].fatherId+")");
		},error:function(data){
			
		}
	});		
}
function updateFileName(fileName){
	alert(chooseFileId)
	$.ajax({
		type:"get",
		url:controllerUrl+"class_resource/updateFileName",
		async:true,
		dataType:"json",
		data:{
			token:localStorage["token"],
			fileName:fileName,
			fileId:chooseFileId
		},success:function(data){
			if(data.info=="success"){
				
				showResource(1);
			}else if(data.info=="no_permission"){
				show("权限不足");
			}
			
		}
	});
	
	
}


</script>



